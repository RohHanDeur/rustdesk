name: Build Windows RustDesk (GUI + MSI)

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    env:
      VCPKG_ROOT: ${{ runner.temp }}\vcpkg

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ------------ Rust Toolchain ------------
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      # ------------ Install MSVC Build Tools ------------
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # ------------ Patch vcpkg.json (Add opus) ------------
      - name: Ensure opus exists in vcpkg.json
        shell: pwsh
        run: |
          if (Test-Path "vcpkg.json") {
            $json = Get-Content "vcpkg.json" | ConvertFrom-Json
            if (-not ($json.dependencies -contains "opus")) {
                Write-Host "Adding opus to vcpkg.json"
                $json.dependencies += "opus"
                $json | ConvertTo-Json -Depth 10 | Out-File "vcpkg.json"
            }
          }

      # ------------ Clone & Bootstrap vcpkg ------------
      - name: Install vcpkg
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg $env:VCPKG_ROOT
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat"

      # ------------ Build Windows EXE ------------
      - name: Build Windows GUI (no HWCodec)
        shell: pwsh
        run: |
          python build.py

      # ------------ Install WiX Toolset ------------
      - name: Install WiX Toolset
        shell: pwsh
        run: |
          $wix = "$env:ProgramFiles\WixToolsetV3"
          mkdir $wix -Force | Out-Null
          Invoke-WebRequest -Uri "https://wixtoolset.org/releases/v3.11.2/wix311-binaries.zip" -OutFile wix.zip
          Expand-Archive wix.zip -DestinationPath $wix
          echo "$wix" | Out-File -Append $env:GITHUB_PATH

      # ------------ Build MSI Installer ------------
      - name: Build Windows MSI
        shell: pwsh
        run: |
          powershell ./build.ps1 -Configuration Release

      # ------------ Upload Artifacts (v4) ------------
      - name: Upload EXE And MSI
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-windows-build
          path: |
            target\release\rustdesk.exe
            target\release\*.msi
