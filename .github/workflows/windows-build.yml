name: Build Windows RustDesk (GUI + MSI)

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ------------------------------------------------------------
      # Install Rust
      # ------------------------------------------------------------
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      # ------------------------------------------------------------
      # Setup MSBuild (for WiX)
      # ------------------------------------------------------------
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # ------------------------------------------------------------
      # Install vcpkg
      # ------------------------------------------------------------
      - name: Install vcpkg
        shell: pwsh
        run: |
          $vcpkgPath = Join-Path $env:RUNNER_TEMP "vcpkg"
          git clone https://github.com/microsoft/vcpkg $vcpkgPath
          & "$vcpkgPath\bootstrap-vcpkg.bat"
          echo "VCPKG_ROOT=$vcpkgPath" | Out-File -Append $env:GITHUB_ENV

      # ------------------------------------------------------------
      # Install Opus (force correct triplet)
      # This FIXES the "opus_multistream.h not found" error
      # ------------------------------------------------------------
      - name: Install Opus library
        shell: pwsh
        run: |
          $vcpkg = "$env:VCPKG_ROOT\vcpkg.exe"
          & $vcpkg install opus --triplet x64-windows

      # ------------------------------------------------------------
      # Build RustDesk (no HWCodec)
      # ------------------------------------------------------------
      - name: Build Windows GUI
        shell: pwsh
        run: |
          python build.py

      # ------------------------------------------------------------
      # Install WiX Toolset (for MSI creation)
      # ------------------------------------------------------------
      - name: Install WiX Toolset
        shell: pwsh
        run: |
          $wix = "$env:ProgramFiles\WixToolsetV3"
          mkdir $wix -Force | Out-Null
          Invoke-WebRequest -Uri "https://wixtoolset.org/releases/v3.11.2/wix311-binaries.zip" -OutFile wix.zip
          Expand-Archive wix.zip -DestinationPath $wix
          echo "$wix" | Out-File -Append $env:GITHUB_PATH

      # ------------------------------------------------------------
      # Build MSI Installer
      # ------------------------------------------------------------
      - name: Build Windows MSI
        shell: pwsh
        run: |
          powershell ./build.ps1 -Configuration Release

      # ------------------------------------------------------------
      # Upload artifacts (EXE + MSI)
      # ------------------------------------------------------------
      - name: Upload EXE + MSI
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-windows-build
          path: |
            target\release\rustdesk.exe
            target\release\*.msi
