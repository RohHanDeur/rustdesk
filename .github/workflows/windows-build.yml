name: Build Windows RustDesk (GUI + MSI)

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install MSVC build tools
        uses: microsoft/setup-msbuild@v2

      # Python은 build.py 실행용으로만 필요함
      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Clone vcpkg
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg.git "$env:TEMP/vcpkg"
          $env:VCPKG_ROOT = "$env:TEMP/vcpkg"
          "$env:VCPKG_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Append
          & "$env:TEMP/vcpkg/bootstrap-vcpkg.bat"

      # hwcodec 제거된 기본 Windows 빌드
      - name: Build Windows EXE (no hwcodec)
        shell: pwsh
        run: |
          python build.py

      - name: Install WiX Toolset
        shell: pwsh
        run: |
          iwr -useb "https://wixtoolset.org/releases/v3.11.2/wix311-binaries.zip" -OutFile wix.zip
          Expand-Archive wix.zip -DestinationPath "C:\wix"
          echo "WIX=C:\wix" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Build MSI installer
        shell: pwsh
        run: |
          powershell ./build.ps1 -Configuration Release

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Build
          path: |
            target\release\*.exe
            target\release\*.msi
