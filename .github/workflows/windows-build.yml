name: Build RustDesk Windows GUI (EXE + MSI)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - ".github/workflows/windows-build.yml"
      - "Cargo.toml"
      - "Cargo.lock"
      - "src/**"
      - "libs/**"
      - "vcpkg.json"

env:
  # 정적으로 링크된 CRT
  RUSTFLAGS: "-C target-feature=+crt-static"
  VCPKG_DEFAULT_TRIPLET: x64-windows-static
  VCPKG_ROOT: ${{ github.workspace }}\vcpkg

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust (stable MSVC)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      # vcpkg 설치
      - name: Install vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg $env:VCPKG_ROOT
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat"

      # vcpkg.json에 opus 의존성이 없으면 자동 추가
      - name: Ensure opus in vcpkg.json (manifest mode)
        run: |
          $path = "vcpkg.json"
          if (-Not (Test-Path $path)) {
            Write-Error "vcpkg.json not found in repository root."
            exit 1
          }

          $json = Get-Content $path -Raw | ConvertFrom-Json

          # dependencies가 문자열 배열 또는 객체 배열인 경우 모두 처리
          $deps = @()
          if ($json.dependencies -is [System.Collections.IEnumerable]) {
            $deps = [System.Collections.ArrayList]@($json.dependencies)
          } elseif ($null -ne $json.dependencies) {
            $deps = [System.Collections.ArrayList]@($json.dependencies)
          }

          $hasOpus = $false
          foreach ($d in $deps) {
            if ($d -is [string] -and $d -eq "opus") {
              $hasOpus = $true
            } elseif ($d.PSObject.Properties.Name -contains "name" -and $d.name -eq "opus") {
              $hasOpus = $true
            }
          }

          if (-not $hasOpus) {
            Write-Host "opus is not in dependencies. Adding opus..."
            if ($deps.Count -eq 0) {
              $json.dependencies = @("opus")
            } else {
              $deps.Add("opus") | Out-Null
              $json.dependencies = $deps
            }
            $json | ConvertTo-Json -Depth 10 | Set-Content $path -Encoding UTF8
          } else {
            Write-Host "opus already present in vcpkg.json"
          }

      # manifest 모드로 vcpkg 의존성 설치
      - name: vcpkg install (manifest, x64-windows-static)
        run: |
          cd ${{ github.workspace }}
          & "$env:VCPKG_ROOT\vcpkg.exe" install --triplet x64-windows-static

      - name: Add vcpkg to PATH
        run: |
          echo "$env:VCPKG_ROOT" | Out-File -FilePath $env:GITHUB_PATH -Append

      # WiX Toolset 설치 (MSI 빌드용)
      - name: Install WiX Toolset
        run: |
          choco install wixtoolset --yes
          $wixPath = "C:\Program Files (x86)\WiX Toolset v3.11\bin"
          if (-Not (Test-Path $wixPath)) {
            Write-Error "WiX bin path not found: $wixPath"
            exit 1
          }
          echo $wixPath | Out-File -FilePath $env:GITHUB_PATH -Append

      # RustDesk GUI 빌드 (hwcodec 비활성화 예시)
      - name: Build RustDesk GUI (no hwcodec)
        run: |
          cd ${{ github.workspace }}
          # ⚠️ 여기 명령은 실제 프로젝트에서 사용하는 빌드 명령으로 교체하세요
          # 예시 1: Sciter GUI + hwcodec 비활성화
          # cargo build --release --bin rustdesk --no-default-features --features "sciter"
          #
          # 예시 2: Flutter GUI 사용 시 (실제 CI 명령 참고)
          # cargo run --package xtask --release -- build --platform windows
          cargo build --release --bin rustdesk

      # WiX로 MSI 생성 (경로 / 파일명은 레포 구조에 맞게 조정)
      - name: Build MSI via WiX
        run: |
          cd ${{ github.workspace }}
          # ⚠️ 실제 .wxs 파일 경로로 수정 필요
          # 예: installer\windows\rustdesk.wxs 존재한다고 가정
          if (-Not (Test-Path "installer\windows\rustdesk.wxs")) {
            Write-Error "WiX source file installer\windows\rustdesk.wxs not found."
            exit 1
          }

          mkdir obj -ErrorAction SilentlyContinue | Out-Null

          candle.exe installer\windows\rustdesk.wxs -out obj\rustdesk.wixobj
          if ($LASTEXITCODE -ne 0) {
            Write-Error "candle.exe failed."
            exit 1
          }

          light.exe obj\rustdesk.wixobj -o target\release\rustdesk-x64.msi
          if ($LASTEXITCODE -ne 0) {
            Write-Error "light.exe failed."
            exit 1
          }

      # EXE + MSI 아티팩트 업로드
      - name: Upload artifacts (EXE + MSI)
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-windows-x64
          path: |
            target\release\rustdesk.exe
            target\release\rustdesk-x64.msi
